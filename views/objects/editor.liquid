<!DOCTYPE html>
<html lang="en">
<head>
    {% render 'partials/head.liquid' %}
    <title>{{ project.name }} - Object Designer</title>
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; }
        .code-editor {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            line-height: 1.5;
        }
    </style>
</head>
<body class="flex flex-col h-screen bg-black text-white font-sans antialiased selection:bg-blue-500 selection:text-white">

    {% render 'partials/header.liquid', is_page_editor: false, is_object_editor: true, project: project, user: user %}
    {% render 'partials/notifications.liquid' %}

    <!-- Editor Toolbar -->
    <div class="flex items-center justify-between px-6 py-2 border-b border-white/10 bg-[#1c1c1e] z-40">
        <div class="flex items-center gap-2">
             <div class="flex items-center gap-2">
                <a href="/app/{{ project.slug | default: project._id }}" class="text-sm text-gray-400 hover:text-white transition-colors">{{ project.name }}</a>
                <span class="text-gray-600">/</span>
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    {% if isNew %}
                    <span class="text-sm font-medium text-white">New Object</span>
                    {% else %}
                    <span class="text-sm font-medium text-white">{{ object.label }} ({{ object.name }})</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <button onclick="copyToClipboard()" class="text-xs bg-white/5 hover:bg-white/10 text-gray-300 px-3 py-1.5 rounded transition-colors">Copy YAML</button>

            <div class="h-6 w-px bg-white/10 mx-1"></div>

            <button onclick="saveObject()" class="bg-[#007AFF] hover:bg-[#0062cc] text-white px-4 py-1.5 rounded-lg text-sm font-medium transition-all shadow-lg shadow-blue-900/20 hover:shadow-blue-900/40 flex items-center gap-2 transform active:scale-95">
                <span>Save Object</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
            </button>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar Removed -->

        <!-- Main Content / Code Editor -->
        <div id="editorWrapper" class="flex-1 flex flex-col bg-[#1c1c1e] border-r border-white/10 relative">
            <div id="editor-container" class="flex-1 relative"></div>
        </div>

        <!-- Preview -->
        <div id="previewWrapper" class="flex-1 bg-white relative min-w-0">
            <!-- This iframe will host the rendered Object form/list preview -->
            <div class="absolute inset-0 bg-gray-50 flex items-center justify-center text-gray-400">
                <iframe id="preview" class="w-full h-full border-none"></iframe>
            </div>
        </div>

        <!-- AI Chat Sidebar -->
        <div id="aiChatSidebar" class="w-80 md:w-96 bg-[#1c1c1e] border-l border-white/10 flex-col transition-all duration-300 flex">
            <div class="p-4 border-b border-white/10 bg-[#2c2c2e] flex justify-between items-center">
                <h3 class="font-bold text-white flex items-center gap-2">
                    <span class="text-xl">âœ¨</span> AI Object Designer
                </h3>
            </div>
            
            <div id="aiChatMessages" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-600 to-blue-600 flex items-center justify-center text-xs flex-shrink-0">AI</div>
                    <div class="bg-white/10 rounded-2xl rounded-tl-none px-4 py-2 text-sm text-gray-200">
                        Hi! describe the data object you want to build. I will generate the Steedos Object YAML for you.
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-white/10 bg-[#2c2c2e]">
                <div class="mb-3">
                    <div class="relative">
                        <select id="aiModelSelect" class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:border-purple-500 focus:ring-1 focus:ring-purple-500 focus:outline-none transition-colors appearance-none cursor-pointer hover:bg-white/5 disabled:opacity-50 disabled:cursor-not-allowed">
                            <option value="gpt-4o">Loading models...</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                        </div>
                    </div>
                </div>
                <div class="relative">
                    <textarea id="aiChatInput" rows="1" class="w-full bg-black/20 border border-white/10 rounded-xl pl-4 pr-10 py-3 text-white focus:border-purple-500 focus:ring-1 focus:ring-purple-500 focus:outline-none transition-colors resize-none text-sm" placeholder="Describe your object..."></textarea>
                    <button id="aiChatSend" class="absolute right-2 top-2 p-1.5 text-purple-500 hover:text-purple-400 transition-colors rounded-lg hover:bg-white/5">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>

    <script>
        const isNew = {{ isNew | default: false }};
        const objectId = "{{ object._id }}";
        const projectId = "{{ projectId }}";
        const initialSchema = {{ object.schema | json | default: "''" }};

        let editor;

        // 1. Initialize Monaco Editor
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
        
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: initialSchema || '# Describe your object in AI chat, or type YAML here...',
                language: 'yaml',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: false },
                fontSize: 14,
                padding: { top: 20 }
            });

            // Listen for changes
            editor.onDidChangeModelContent(() => {
                updateSaveButtonState();
                updatePreview();
            });

            updateSaveButtonState();
            updatePreview();
        });

        // 2. Preview Logic
        function updatePreview() {
            const schema = editor.getValue();
            const previewFrame = document.getElementById('preview');
            const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;

            try {
                const obj = jsyaml.load(schema);
                
                if (!obj) {
                    renderEmpty(doc, 'Start typing to see preview...');
                    return;
                }

                renderForm(doc, obj);
            } catch (e) {
                renderError(doc, e.message);
            }
        }

        function renderForm(doc, obj) {
            const fields = obj.fields || {};
            const label = obj.label || obj.name || 'Untitled Object';
            const icon = obj.icon || 'cube';

            let fieldsHtml = '';
            
            for (const [key, field] of Object.entries(fields)) {
                fieldsHtml += generateFieldHtml(key, field);
            }

            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <style>
                        body { background-color: #f9fafb; }
                    </style>
                </head>
                <body class="p-6">
                    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <!-- Header -->
                        <div class="border-b border-gray-100 bg-gray-50/50 px-6 py-4 flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center text-white shadow-sm">
                                <span class="material-icons text-xl">${icon.substring(0,2)}</span>
                            </div>
                            <div>
                                <h1 class="text-lg font-semibold text-gray-900">${label}</h1>
                                <p class="text-xs text-gray-500">New Record</p>
                            </div>
                        </div>

                        <!-- Form -->
                        <div class="p-6 space-y-6">
                            ${fieldsHtml || '<p class="text-center text-gray-400 py-8">No fields defined yet.</p>'}
                            
                            <!-- Actions -->
                            <div class="pt-4 border-t border-gray-100 flex justify-end gap-3">
                                <button class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 shadow-sm">Cancel</button>
                                <button class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 shadow-sm">Save</button>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            doc.open();
            doc.write(html);
            doc.close();
        }

        function generateFieldHtml(key, field) {
            const label = field.label || key;
            const required = field.required ? '<span class="text-red-500">*</span>' : '';
            const help = field.help ? `<p class="mt-1 text-xs text-gray-500">${field.help}</p>` : '';
            
            let inputHtml = '';

            switch (field.type) {
                case 'textarea':
                    inputHtml = `<textarea class="w-full rounded-lg border-gray-300 border shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2.5 min-h-[100px]" placeholder="Enter ${label.toLowerCase()}..."></textarea>`;
                    break;
                case 'select':
                    const options = field.options || [];
                    const optionsHtml = options.map(opt => {
                        const val = typeof opt === 'object' ? opt.value : opt;
                        const lbl = typeof opt === 'object' ? opt.label : opt;
                        return `<option value="${val}">${lbl}</option>`;
                    }).join('');
                    inputHtml = `
                        <select class="w-full rounded-lg border-gray-300 border shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2.5 bg-white">
                            <option value="">Select an option...</option>
                            ${optionsHtml}
                        </select>`;
                    break;
                case 'boolean':
                    inputHtml = `
                        <div class="flex items-center h-6 mt-2">
                            <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600">
                            <span class="ml-2 text-sm text-gray-600">Yes, enable this option</span>
                        </div>`;
                    break;
                case 'date':
                case 'datetime':
                    inputHtml = `<input type="date" class="w-full rounded-lg border-gray-300 border shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2.5">`;
                    break;
                default: // text, number, etc.
                    inputHtml = `<input type="text" class="w-full rounded-lg border-gray-300 border shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2.5" placeholder="Enter ${label.toLowerCase()}...">`;
            }

            return `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${label} ${required}</label>
                    ${inputHtml}
                    ${help}
                </div>
            `;
        }

        function renderEmpty(doc, msg) {
            doc.open();
            doc.write(`
                <!DOCTYPE html><html><head><script src="https://cdn.tailwindcss.com"><\/script></head>
                <body class="h-screen flex items-center justify-center bg-gray-50 text-gray-400 text-sm">
                    ${msg}
                </body></html>
            `);
            doc.close();
        }

        function renderError(doc, msg) {
            doc.open();
            doc.write(`
                <!DOCTYPE html><html><head><script src="https://cdn.tailwindcss.com"><\/script></head>
                <body class="p-6 bg-red-50 h-screen">
                    <div class="text-red-600 font-mono text-sm bg-white p-4 rounded-lg shadow-sm border border-red-200">
                        <strong>YAML Error:</strong><br/>${msg}
                    </div>
                </body></html>
            `);
            doc.close();
        }

        // 2. Save Logic
        function updateSaveButtonState() {
             // Basic state management
        }

        async function saveObject() {
            const schema = editor.getValue().trim();
            if (!schema) {
                $notify('Please enter or generate a schema first', 'warning');
                return;
            }

            // Simple parsing to extract name and label
            const nameMatch = schema.match(/^name:\s*(.+)$/m);
            const labelMatch = schema.match(/^label:\s*(.+)$/m);
            const descriptionMatch = schema.match(/^description:\s*(.+)$/m);

            const data = {
                projectId: projectId,
                schema: schema,
                name: nameMatch ? nameMatch[1].trim() : (isNew ? 'untitled' : '{{ object.name }}'),
                label: labelMatch ? labelMatch[1].trim() : (isNew ? 'Untitled' : '{{ object.label }}'),
                description: descriptionMatch ? descriptionMatch[1].trim() : '',
                icon: 'cube'
            };

            try {
                const url = isNew ? `/app/${projectId}/objects` : `/app/${projectId}/objects/${objectId}`;
                const method = isNew ? 'POST' : 'PUT';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to save');

                const savedObj = await response.json();
                
                showStatus('Object saved successfully!', 'success');
                
                if (isNew) {
                     setTimeout(() => {
                        window.location.href = `/app/${projectId}/objects/${savedObj._id}`;
                    }, 500);
                }
            } catch (error) {
                console.error(error);
                showStatus('Failed to save object.', 'error');
            }
        }

        function showStatus(msg, type) {
            $notify(msg, type);
        }

        function copyToClipboard() {
            const val = editor.getValue();
            navigator.clipboard.writeText(val).then(() => {
                const btn = document.querySelector('button[onclick="copyToClipboard()"]');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }
        
        // 3. AI Chat Logic (Copied and adapted from Page Editor)
        const aiChatInput = document.getElementById('aiChatInput');
        const aiChatSend = document.getElementById('aiChatSend');
        const aiChatMessages = document.getElementById('aiChatMessages');

        function addMessage(role, text) {
            const div = document.createElement('div');
            div.className = 'flex gap-3 ' + (role === 'user' ? 'flex-row-reverse' : '');
            
            const avatar = role === 'user' 
                ? `<div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-xs flex-shrink-0">You</div>`
                : `<div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-600 to-blue-600 flex items-center justify-center text-xs flex-shrink-0">AI</div>`;
            
            const bubble = `<div class="${role === 'user' ? 'bg-blue-600 text-white' : 'bg-white/10 text-gray-200'} rounded-2xl ${role === 'user' ? 'rounded-tr-none' : 'rounded-tl-none'} px-4 py-2 text-sm whitespace-pre-wrap">${text}</div>`;
            
            div.innerHTML = role === 'user' ? bubble + avatar : avatar + bubble;
            aiChatMessages.appendChild(div);
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
        }

        async function handleAiSend() {
            const prompt = aiChatInput.value.trim();
            if (!prompt) return;

            addMessage('user', prompt);
            aiChatInput.value = '';
            aiChatInput.style.height = 'auto';

            // Show loading
            const loadingId = 'ai-loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'flex gap-3';
            loadingDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-600 to-blue-600 flex items-center justify-center text-xs flex-shrink-0">AI</div>
                <div class="bg-white/10 rounded-2xl rounded-tl-none px-4 py-2 text-sm text-gray-200 flex items-center gap-2">
                    <span>Thinking</span>
                    <span class="animate-bounce">.</span><span class="animate-bounce delay-100">.</span><span class="animate-bounce delay-200">.</span>
                </div>
            `;
            aiChatMessages.appendChild(loadingDiv);
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;

            try {
                const currentCode = editor ? editor.getValue() : '';
                const model = document.getElementById('aiModelSelect').value;
                const response = await fetch('/api/ai/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, currentCode, model, type: 'object' })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (response.ok && data.code) {
                    addMessage('ai', 'I have updated the Object schema based on your request.');
                    editor.setValue(data.code);
                } else {
                    addMessage('ai', 'Sorry, something went wrong: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                if (document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                addMessage('ai', 'Sorry, I encountered a network error.');
            }
        }

        if (aiChatSend) aiChatSend.addEventListener('click', handleAiSend);
        if (aiChatInput) {
            aiChatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleAiSend();
                }
            });
            // Auto resize
            aiChatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        }

        // Fetch and cache models (Same as Page Editor - reuse logic ideally)
        async function loadModels() {
            const modelSelect = document.getElementById('aiModelSelect');
            if (!modelSelect) return;

            const fallbackModels = [
                { id: 'gpt-4o' },
                { id: 'google/gemini-3-pro-preview' }
            ];

            try {
                const res = await fetch('/api/ai/models');
                if (res.ok) {
                    let models = await res.json();
                    // If backend returns empty array (e.g. no API key), use fallback
                    if (!models || !Array.isArray(models) || models.length === 0) {
                        models = fallbackModels;
                    }
                    renderModels(models);
                } else {
                     renderModels(fallbackModels);
                }
            } catch (e) { 
                console.error('Error loading models:', e); 
                renderModels(fallbackModels);
            }
        }

        function renderModels(models) {
            const modelSelect = document.getElementById('aiModelSelect');
            if (!modelSelect) return;
            modelSelect.innerHTML = models.map(m => `<option value="${m.id}">${m.id}</option>`).join('');
            const savedModel = localStorage.getItem('ai_selected_model');
            if (savedModel) modelSelect.value = savedModel;
            modelSelect.addEventListener('change', () => localStorage.setItem('ai_selected_model', modelSelect.value));
        }

        loadModels();

    </script>
</body>
</html>
